<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doc_rag local dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="light-theme">
  <div class="app-container">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Settings</h2>
        <button id="closeSidebar" class="close-btn">&times;</button>
      </div>
      <div class="sidebar-content">
        <div class="sidebar-section">
          <h3>LLM Configuration</h3>
          <div class="input-group">
            <label for="collection">Collection</label>
            <select id="collection">
              <option value="all" selected>전체 (기본)</option>
            </select>
            <small id="collectionHint" class="helper-text">컬렉션 정보를 로딩 중입니다.</small>
          </div>
          <div class="input-group">
            <label for="provider">LLM Provider</label>
            <select id="provider">
              <option value="ollama" selected>ollama</option>
              <option value="openai">openai</option>
              <option value="lmstudio">lmstudio</option>
            </select>
          </div>
          <div class="input-group">
            <label for="model">LLM Model</label>
            <input type="text" id="model" value="qwen3:4b">
          </div>
          <div class="input-group">
            <label for="baseUrl">Base URL (optional)</label>
            <input type="text" id="baseUrl" value="http://localhost:11434">
          </div>
          <div class="input-group">
            <label for="apiKey">API Key (optional)</label>
            <input type="password" id="apiKey" value="">
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Health</h3>
          <div id="statusIndicator" class="status-indicator">
            <span class="status-dot"></span>
            <span class="status-text">Checking...</span>
          </div>
          <p id="statusMsg" class="status-msg">로컬 서버 상태를 확인 중입니다.</p>
          <div class="sidebar-actions">
            <button id="healthBtn" class="secondary-btn">Health Check</button>
            <button id="reindexBtn" class="primary-btn">Reindex</button>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>RAG Documents</h3>
          <div class="doc-list" id="docList">
            <p class="status-msg">문서 목록 로딩 중...</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Upload Request</h3>
          <div class="input-group">
            <label for="uploadSource">Source Name</label>
            <input type="text" id="uploadSource" placeholder="example.md">
          </div>
          <div class="input-row">
            <div class="input-group">
              <label for="uploadCountry">Country</label>
              <select id="uploadCountry">
                <option value="">(collection 기본값)</option>
                <option value="all">all</option>
                <option value="france">france</option>
                <option value="germany">germany</option>
                <option value="italy">italy</option>
                <option value="uk">uk</option>
              </select>
            </div>
            <div class="input-group">
              <label for="uploadDocType">Doc Type</label>
              <select id="uploadDocType">
                <option value="">(collection 기본값)</option>
                <option value="summary">summary</option>
                <option value="country">country</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label for="uploadContent">Markdown Content</label>
            <textarea id="uploadContent" rows="6" placeholder="## 제목&#10;본문 내용을 입력하세요."></textarea>
          </div>
          <div class="sidebar-actions">
            <button id="uploadBtn" class="primary-btn">업로드 요청</button>
          </div>
          <p id="uploadMsg" class="status-msg" style="margin-top:8px;"></p>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <div class="header-left">
          <button id="menuToggle" class="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <h1>Trunk RAG : Chatbot</h1>
        </div>
      </header>

      <section class="chat-layout">
        <div class="main-chat-container" id="chatContainer">
          <div class="chat-message bot">
            안녕하세요. 문서 기반 RAG 어시스턴트입니다. 질문을 입력해 주세요.
          </div>
        </div>
        <div class="main-chat-input">
          <textarea id="userInput" rows="2" placeholder="질문을 입력하세요..."></textarea>
          <button id="sendBtn" class="primary-btn">Send</button>
        </div>
      </section>

      <section class="doc-viewer-layout">
        <div class="card">
          <h3 id="docTitle">Document Viewer</h3>
          <div class="doc-viewer-body" id="docViewer">
            <p class="status-msg">왼쪽 문서 목록에서 파일을 선택하면 내용을 볼 수 있습니다.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    const menuToggle = document.getElementById("menuToggle");
    const closeSidebar = document.getElementById("closeSidebar");

    const provider = document.getElementById("provider");
    const model = document.getElementById("model");
    const baseUrl = document.getElementById("baseUrl");
    const apiKey = document.getElementById("apiKey");
    const collection = document.getElementById("collection");
    const collectionHint = document.getElementById("collectionHint");
    const userInput = document.getElementById("userInput");

    const sendBtn = document.getElementById("sendBtn");
    const healthBtn = document.getElementById("healthBtn");
    const reindexBtn = document.getElementById("reindexBtn");

    const chatContainer = document.getElementById("chatContainer");
    const statusIndicator = document.getElementById("statusIndicator");
    const statusMsg = document.getElementById("statusMsg");
    const docList = document.getElementById("docList");
    const docTitle = document.getElementById("docTitle");
    const docViewer = document.getElementById("docViewer");
    const uploadSource = document.getElementById("uploadSource");
    const uploadCountry = document.getElementById("uploadCountry");
    const uploadDocType = document.getElementById("uploadDocType");
    const uploadContent = document.getElementById("uploadContent");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadMsg = document.getElementById("uploadMsg");
    let collectionItems = [];

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function renderMarkdownBasic(markdown) {
      const lines = markdown.split("\n");
      const html = [];
      let inList = false;
      let inCode = false;
      for (const line of lines) {
        if (line.startsWith("```")) {
          if (!inCode) {
            html.push("<pre><code>");
            inCode = true;
          } else {
            html.push("</code></pre>");
            inCode = false;
          }
          continue;
        }
        if (inCode) {
          html.push(escapeHtml(line) + "\n");
          continue;
        }

        const text = escapeHtml(line);
        if (text.startsWith("#### ")) {
          if (inList) { html.push("</ul>"); inList = false; }
          html.push("<h4>" + text.slice(5) + "</h4>");
        } else if (text.startsWith("### ")) {
          if (inList) { html.push("</ul>"); inList = false; }
          html.push("<h3>" + text.slice(4) + "</h3>");
        } else if (text.startsWith("## ")) {
          if (inList) { html.push("</ul>"); inList = false; }
          html.push("<h2>" + text.slice(3) + "</h2>");
        } else if (text.startsWith("- ")) {
          if (!inList) { html.push("<ul>"); inList = true; }
          html.push("<li>" + text.slice(2) + "</li>");
        } else if (text.trim() === "") {
          if (inList) { html.push("</ul>"); inList = false; }
          html.push("<br>");
        } else {
          if (inList) { html.push("</ul>"); inList = false; }
          html.push("<p>" + text + "</p>");
        }
      }
      if (inList) html.push("</ul>");
      if (inCode) html.push("</code></pre>");
      return html.join("");
    }

    function appendMessage(role, text) {
      const message = document.createElement("div");
      message.className = "chat-message " + role;
      message.textContent = text;
      chatContainer.appendChild(message);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function setStatus(type, text, detail) {
      statusIndicator.className = "status-indicator " + type;
      statusIndicator.querySelector(".status-text").textContent = text;
      statusMsg.textContent = detail || "";
    }

    function parseApiError(data, fallbackMessage) {
      if (!data || typeof data !== "object") {
        return { message: fallbackMessage, hint: "", requestId: "" };
      }
      const detailMessage =
        typeof data.detail === "string"
          ? data.detail
          : (data.detail && typeof data.detail === "object" ? (data.detail.message || JSON.stringify(data.detail)) : "");
      const hint = data.hint || (data.detail && typeof data.detail === "object" ? (data.detail.hint || "") : "");
      return {
        message: data.message || detailMessage || fallbackMessage,
        hint,
        requestId: data.request_id || ""
      };
    }

    function formatApiError(error) {
      const parts = [error.message];
      if (error.hint) parts.push(`hint: ${error.hint}`);
      if (error.requestId) parts.push(`request_id: ${error.requestId}`);
      return parts.join(" | ");
    }

    function syncDefaults() {
      if (provider.value === "ollama") {
        model.value = "qwen3:4b";
        baseUrl.value = "http://localhost:11434";
      } else if (provider.value === "lmstudio") {
        model.value = "local-model";
        baseUrl.value = "http://localhost:1234/v1";
      } else {
        model.value = "gpt-4o-mini";
        baseUrl.value = "";
      }
    }

    function collectionDisplayText(item) {
      const softPct = Math.round((item.soft_usage_ratio || 0) * 100);
      return `${item.label} (${item.key}) - vectors=${item.vectors}, soft=${softPct}%`;
    }

    function updateCollectionHint() {
      const selected = collectionItems.find((item) => item.key === collection.value);
      if (!selected) return;
      const hardPct = Math.round((selected.hard_usage_ratio || 0) * 100);
      collectionHint.textContent = `선택: ${selected.name} | hard-cap 사용률 ${hardPct}%`;
    }

    async function loadCollections() {
      try {
        const res = await fetch("/collections");
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "컬렉션 로드 실패");
          collectionHint.textContent = formatApiError(error);
          return;
        }

        collectionItems = data.collections || [];
        if (!collectionItems.length) {
          collection.innerHTML = `<option value="all">전체 (기본)</option>`;
          collectionHint.textContent = "컬렉션 정보가 없습니다.";
          return;
        }

        const defaultKey = data.default_collection_key || "all";
        const currentValue = collection.value;
        collection.innerHTML = collectionItems
          .map((item) => `<option value="${item.key}">${collectionDisplayText(item)}</option>`)
          .join("");
        const valueExists = collectionItems.some((item) => item.key === currentValue);
        collection.value = valueExists ? currentValue : defaultKey;
        updateCollectionHint();
      } catch (error) {
        collectionHint.textContent = String(error);
      }
    }

    async function loadDocs() {
      try {
        const res = await fetch("/rag-docs");
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "문서 목록 로드 실패");
          docList.innerHTML = `<p class="status-msg">${escapeHtml(formatApiError(error))}</p>`;
          return;
        }
        if (!data.docs || data.docs.length === 0) {
          docList.innerHTML = "<p class='status-msg'>등록된 문서가 없습니다.</p>";
          return;
        }

        const items = data.docs.map((doc) => `
          <button class="doc-item-btn" data-name="${doc.name}">
            <span class="doc-name">${doc.name}</span>
            <span class="doc-meta">${Math.round(doc.size / 1024)} KB</span>
          </button>
        `).join("");
        docList.innerHTML = items;

        docList.querySelectorAll(".doc-item-btn").forEach((button) => {
          button.addEventListener("click", () => openDoc(button.dataset.name));
        });
      } catch (error) {
        docList.innerHTML = `<p class="status-msg">오류: ${error}</p>`;
      }
    }

    async function openDoc(name) {
      docTitle.textContent = "Document Viewer - " + name;
      docViewer.innerHTML = "<p class='status-msg'>문서 로딩 중...</p>";
      try {
        const res = await fetch("/rag-docs/" + encodeURIComponent(name));
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "문서 조회 실패");
          docViewer.innerHTML = `<p class='status-msg'>${escapeHtml(formatApiError(error))}</p>`;
          return;
        }
        docViewer.innerHTML = renderMarkdownBasic(data.content || "");
      } catch (error) {
        docViewer.innerHTML = `<p class='status-msg'>오류: ${error}</p>`;
      }
    }

    provider.addEventListener("change", syncDefaults);
    collection.addEventListener("change", updateCollectionHint);

    async function healthCheck() {
      try {
        const res = await fetch("/health");
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "health check 실패");
          setStatus("error", "Error", formatApiError(error));
          return;
        }
        setStatus("ok", "Online", `default=${data.collection_key ?? "all"}, vectors=${data.vectors ?? "-"}`);
      } catch (err) {
        setStatus("error", "Offline", String(err));
      }
    }

    async function sendQuestion() {
      const question = userInput.value.trim();
      if (!question) return;

      appendMessage("user", question);
      appendMessage("bot", "생성 중...");
      const pending = chatContainer.lastElementChild;

      const payload = {
        query: question,
        llm_provider: provider.value,
        llm_model: model.value || null,
        llm_api_key: apiKey.value || null,
        llm_base_url: baseUrl.value || null,
        collection: collection.value || null
      };

      try {
        const res = await fetch("/query", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "요청 실패");
          pending.textContent = formatApiError(error);
          return;
        }
        pending.textContent = data.answer;
      } catch (err) {
        pending.textContent = "오류: " + err;
      }

      userInput.value = "";
    }

    async function reindex() {
      setStatus("warn", "Working", "문서 재인덱싱 중...");
      try {
        const res = await fetch("/reindex", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({reset: true, collection: collection.value || null})
        });
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "reindex 실패");
          setStatus("error", "Error", formatApiError(error));
          return;
        }
        const collectionName = data.collection || collection.value || "all";
        setStatus("ok", "Online", `reindex 완료: collection=${collectionName}, vectors=${data.vectors}`);
        appendMessage("bot", `재인덱싱 완료: collection=${collectionName}, vectors=${data.vectors}`);
        await loadDocs();
        await loadCollections();
      } catch (err) {
        setStatus("error", "Error", String(err));
      }
    }

    async function submitUploadRequest() {
      const content = uploadContent.value.trim();
      if (!content) {
        uploadMsg.textContent = "업로드할 Markdown 내용을 입력하세요.";
        return;
      }

      uploadMsg.textContent = "업로드 요청 생성 중...";
      const payload = {
        source_name: uploadSource.value.trim() || null,
        collection: collection.value || null,
        country: uploadCountry.value || null,
        doc_type: uploadDocType.value || null,
        content
      };

      try {
        const res = await fetch("/upload-requests", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          const error = parseApiError(data, "업로드 요청 생성 실패");
          uploadMsg.textContent = formatApiError(error);
          return;
        }

        const request = data.request || {};
        const requestId = request.id || "-";
        const status = request.status || "pending";
        const autoApprove = data.auto_approve ? "on" : "off";
        uploadMsg.textContent = `요청 생성 완료: id=${requestId}, status=${status}, auto_approve=${autoApprove}`;
        appendMessage("bot", `업로드 요청 생성: id=${requestId}, status=${status}`);

        if (status === "approved") {
          await loadCollections();
          await loadDocs();
        }
      } catch (error) {
        uploadMsg.textContent = String(error);
      }
    }

    sendBtn.addEventListener("click", sendQuestion);
    userInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendQuestion();
      }
    });

    healthBtn.addEventListener("click", healthCheck);
    reindexBtn.addEventListener("click", reindex);
    uploadBtn.addEventListener("click", submitUploadRequest);

    menuToggle.addEventListener("click", () => {
      sidebar.classList.add("active");
      sidebarOverlay.classList.add("active");
    });
    closeSidebar.addEventListener("click", () => {
      sidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    });
    sidebarOverlay.addEventListener("click", () => {
      sidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    });

    healthCheck();
    loadCollections();
    loadDocs();
  </script>
</body>
</html>
