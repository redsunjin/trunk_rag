<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doc_rag admin</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="light-theme">
  <div class="app-container">
    <main class="main-content">
      <header class="main-header" style="margin-bottom:16px;">
        <div class="header-left">
          <h1>Trunk RAG : Admin</h1>
        </div>
        <div class="header-actions">
          <button id="refreshBtn" class="secondary-btn">새로고침</button>
          <button id="goUserBtn" class="primary-btn">사용자 화면</button>
        </div>
      </header>

      <section class="card" style="margin-bottom:12px;">
        <h3>관리자 인증</h3>
        <div class="input-row" style="margin-top:10px;">
          <div class="input-group">
            <label for="adminCode">Admin Code</label>
            <input id="adminCode" type="password" placeholder="관리자 인증코드">
          </div>
          <div class="input-group">
            <label for="statusFilter">요청 상태 필터</label>
            <select id="statusFilter">
              <option value="">전체</option>
              <option value="pending" selected>pending</option>
              <option value="approved">approved</option>
              <option value="rejected">rejected</option>
            </select>
          </div>
        </div>
        <p id="adminMsg" class="status-msg"></p>
      </section>

      <section class="card" style="margin-bottom:12px;">
        <h3>컬렉션 현황</h3>
        <p id="collectionMsg" class="status-msg" style="margin-top:8px;">로딩 중...</p>
        <div id="collectionTableWrap" style="margin-top:12px;overflow:auto;"></div>
      </section>

      <section class="card">
        <h3>업로드 요청 승인 워크플로우</h3>
        <p id="requestMsg" class="status-msg" style="margin-top:8px;">요청 목록 로딩 중...</p>
        <div id="requestTableWrap" style="margin-top:12px;overflow:auto;"></div>
      </section>
    </main>
  </div>

  <script>
    const refreshBtn = document.getElementById("refreshBtn");
    const goUserBtn = document.getElementById("goUserBtn");
    const adminCode = document.getElementById("adminCode");
    const adminMsg = document.getElementById("adminMsg");
    const statusFilter = document.getElementById("statusFilter");
    const collectionMsg = document.getElementById("collectionMsg");
    const requestMsg = document.getElementById("requestMsg");
    const collectionTableWrap = document.getElementById("collectionTableWrap");
    const requestTableWrap = document.getElementById("requestTableWrap");

    function escapeHtml(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function parseApiError(data, fallbackMessage) {
      if (!data || typeof data !== "object") {
        return fallbackMessage;
      }
      if (typeof data.detail === "string" && data.detail) return data.detail;
      if (typeof data.message === "string" && data.message) return data.message;
      if (data.detail && typeof data.detail === "object") {
        if (data.detail.message) return String(data.detail.message);
        return JSON.stringify(data.detail);
      }
      return fallbackMessage;
    }

    function renderCollectionTable(items, defaultKey) {
      if (!Array.isArray(items) || items.length === 0) {
        collectionTableWrap.innerHTML = "<p class='status-msg'>컬렉션 정보가 없습니다.</p>";
        return;
      }

      const rows = items.map((item) => {
        const isDefault = item.key === defaultKey ? " (default)" : "";
        const softPct = Math.round((item.soft_usage_ratio || 0) * 100);
        const hardPct = Math.round((item.hard_usage_ratio || 0) * 100);
        const capState = item.hard_exceeded
          ? "hard-cap 초과"
          : (item.soft_exceeded ? "soft-cap 경고" : "정상");
        return `
          <tr>
            <td>${escapeHtml(item.key + isDefault)}</td>
            <td>${escapeHtml(item.label)}</td>
            <td>${escapeHtml(item.name)}</td>
            <td style="text-align:right;">${item.vectors}</td>
            <td style="text-align:right;">${softPct}% / ${hardPct}%</td>
            <td>${escapeHtml(capState)}</td>
          </tr>
        `;
      }).join("");

      collectionTableWrap.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">key</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">label</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">collection</th>
              <th style="text-align:right;border-bottom:1px solid #dee2e6;padding:8px;">vectors</th>
              <th style="text-align:right;border-bottom:1px solid #dee2e6;padding:8px;">cap 사용률</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">상태</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function requestActionButtons(item) {
      if (item.status !== "pending") return "-";
      return `
        <button class="secondary-btn req-approve-btn" data-id="${item.id}" style="padding:4px 10px;">승인</button>
        <button class="secondary-btn req-reject-btn" data-id="${item.id}" style="padding:4px 10px;">반려</button>
      `;
    }

    function renderRequestTable(items, counts) {
      if (!Array.isArray(items) || items.length === 0) {
        requestTableWrap.innerHTML = "<p class='status-msg'>요청 데이터가 없습니다.</p>";
        return;
      }

      const rows = items.map((item) => {
        const usable = item.usable ? "true" : "false";
        const validation = item.validation || {};
        const reasons = Array.isArray(validation.reasons) ? validation.reasons.join(" | ") : "";
        const rejectedReason = item.rejected_reason || "";
        const note = rejectedReason || reasons || "-";
        return `
          <tr>
            <td>${escapeHtml(item.id)}</td>
            <td>${escapeHtml(item.source_name || "-")}</td>
            <td>${escapeHtml(item.collection_key || "-")}</td>
            <td>${escapeHtml(item.status)}</td>
            <td>${usable}</td>
            <td>${escapeHtml(item.created_at || "-")}</td>
            <td>${escapeHtml(note)}</td>
            <td style="display:flex;gap:6px;">${requestActionButtons(item)}</td>
          </tr>
        `;
      }).join("");

      const pending = counts?.pending ?? 0;
      const approved = counts?.approved ?? 0;
      const rejected = counts?.rejected ?? 0;
      requestMsg.textContent = `요청 집계: pending=${pending}, approved=${approved}, rejected=${rejected}`;

      requestTableWrap.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">id</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">source</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">collection</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">status</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">usable</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">created_at</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">notes</th>
              <th style="text-align:left;border-bottom:1px solid #dee2e6;padding:8px;">actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      requestTableWrap.querySelectorAll(".req-approve-btn").forEach((button) => {
        button.addEventListener("click", () => approveRequest(button.dataset.id));
      });
      requestTableWrap.querySelectorAll(".req-reject-btn").forEach((button) => {
        button.addEventListener("click", () => rejectRequest(button.dataset.id));
      });
    }

    function getAdminCode() {
      return adminCode.value.trim();
    }

    async function loadCollections() {
      collectionMsg.textContent = "컬렉션 상태를 조회 중입니다.";
      try {
        const res = await fetch("/collections");
        const data = await res.json();
        if (!res.ok) {
          collectionMsg.textContent = "컬렉션 상태 조회 실패";
          return;
        }
        renderCollectionTable(data.collections || [], data.default_collection_key || "all");
        collectionMsg.textContent = `조회 완료: ${data.collections?.length || 0}개 컬렉션, auto_approve=${data.auto_approve ? "on" : "off"}`;
      } catch (error) {
        collectionMsg.textContent = String(error);
      }
    }

    async function loadRequests() {
      requestMsg.textContent = "요청 목록을 조회 중입니다.";
      const params = new URLSearchParams();
      if (statusFilter.value) params.set("status", statusFilter.value);
      const suffix = params.toString() ? `?${params.toString()}` : "";
      try {
        const res = await fetch(`/upload-requests${suffix}`);
        const data = await res.json();
        if (!res.ok) {
          requestMsg.textContent = parseApiError(data, "요청 조회 실패");
          return;
        }
        renderRequestTable(data.requests || [], data.counts || {});
      } catch (error) {
        requestMsg.textContent = String(error);
      }
    }

    async function approveRequest(requestId) {
      const code = getAdminCode();
      if (!code) {
        adminMsg.textContent = "관리자 코드를 먼저 입력하세요.";
        return;
      }

      adminMsg.textContent = `승인 처리 중: ${requestId}`;
      try {
        const res = await fetch(`/upload-requests/${encodeURIComponent(requestId)}/approve`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({code})
        });
        const data = await res.json();
        if (!res.ok) {
          adminMsg.textContent = parseApiError(data, "승인 실패");
          return;
        }
        adminMsg.textContent = `승인 완료: ${requestId}`;
        await loadRequests();
        await loadCollections();
      } catch (error) {
        adminMsg.textContent = String(error);
      }
    }

    async function rejectRequest(requestId) {
      const code = getAdminCode();
      if (!code) {
        adminMsg.textContent = "관리자 코드를 먼저 입력하세요.";
        return;
      }

      const reason = prompt("반려 사유를 입력하세요:");
      if (!reason || !reason.trim()) {
        adminMsg.textContent = "반려 사유 입력이 취소되었습니다.";
        return;
      }

      adminMsg.textContent = `반려 처리 중: ${requestId}`;
      try {
        const res = await fetch(`/upload-requests/${encodeURIComponent(requestId)}/reject`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({code, reason: reason.trim()})
        });
        const data = await res.json();
        if (!res.ok) {
          adminMsg.textContent = parseApiError(data, "반려 실패");
          return;
        }
        adminMsg.textContent = `반려 완료: ${requestId}`;
        await loadRequests();
      } catch (error) {
        adminMsg.textContent = String(error);
      }
    }

    refreshBtn.addEventListener("click", async () => {
      await loadCollections();
      await loadRequests();
    });
    statusFilter.addEventListener("change", loadRequests);
    goUserBtn.addEventListener("click", () => { location.href = "/app"; });

    loadCollections();
    loadRequests();
  </script>
</body>
</html>

