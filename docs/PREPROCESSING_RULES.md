# Markdown 전처리 규칙 초안 (P0)

목적:
- 원본 Markdown 품질을 일정하게 맞춰 인덱싱/검색 품질 편차를 줄인다.
- 현재 단계(P0)는 차단(fail)보다 경고(warn) 중심으로 운영한다.

운영 경계:
- 원본 정제/재작성은 외부 전처리 단계에서 수행한다.
- `trunk_rag`는 본 규칙을 기준으로 "사용 가능/불가" 검증 게이트를 제공한다.

적용 범위:
- 입력: `data/*.md` 원본 문서
- 출력: P1에서 분리될 전처리 스크립트(`scripts/preprocess_md.py`)의 정제 결과물

## 1) 적용 강도

- 기본 모드: `warn`
- 의미:
  - 규칙 위반 시 인덱싱을 즉시 차단하지 않는다.
  - 위반 항목을 로그/리포트로 남기고 수정 권고를 제공한다.
- P1 전환 기준(초안):
  - 핵심 규칙 위반률이 연속 2회 0%일 때 `fail` 모드 검토

## 2) 헤더 구조 규칙

- 허용 헤더: `##`, `###`, `####`
- 권장:
  - 문서는 최소 1개 이상의 `##` 섹션을 포함
  - `###`는 가장 가까운 상위 `##` 아래에서만 사용
  - `####`는 가장 가까운 상위 `###` 아래에서만 사용
- 경고 조건:
  - `#` 단독 제목만 있고 `##` 이하 구조가 전혀 없음
  - `####`가 나오기 전에 `###`가 없음
  - 동일 레벨 헤더가 연속 중복되며 본문이 비어 있음

## 3) 길이 규칙

- 제목 최소 길이: 2자 이상
- 본문 최소 길이:
  - 각 섹션(`##`/`###`/`####`) 본문 20자 이상 권장
  - 20자 미만은 경고
- 문서 전체 최소 길이: 200자 이상 권장

## 4) 금지 패턴

- 빈 섹션:
  - 헤더 다음에 본문이 없거나 공백/구분선만 존재
- 중복 헤더:
  - 같은 부모 아래 동일 제목이 2회 이상 반복
- 과도한 구분선:
  - `---` 또는 `***`가 연속으로 과도하게 반복되어 본문 흐름을 깨는 경우
- 메타데이터 누락:
  - 최소 메타데이터 값이 파생 불가능하거나 비어 있는 경우

## 5) 메타데이터 최소 항목

최소 필드:
- `source`: 원본 파일명 (`fr.md` 등)
- `country`: 국가 구분 값 (`france`, `germany`, `italy`, `uk`, `all`)
- `doc_type`: 문서 유형 (`summary` 또는 `country`)

현재 프로젝트 기본 파생 규칙:
- `source` = 파일명
- `country` = 파일 stem 매핑(`common.py`의 `COUNTRY_BY_STEM`)
- `doc_type` = `eu_summry.md`는 `summary`, 그 외 `country`

## 6) 샘플 입력/출력

샘플 입력(원본):

```md
# 프랑스 과학사

## 절대왕정과 과학
루이 14세 시기의 과학 정책은 국가 권력 강화와 연결되었다.

### 마를리 기계
162m 양수 사례는 국가 주도 거대 과학의 상징으로 해석된다.

#### 기술적 의미
대규모 펌프 시스템과 공학적 표준화의 초기 사례다.
```

샘플 출력(정제 메타 포함 예시):

```json
{
  "source": "fr.md",
  "country": "france",
  "doc_type": "country",
  "sections": [
    {
      "h2": "절대왕정과 과학",
      "h3": "마를리 기계",
      "h4": "기술적 의미",
      "content": "대규모 펌프 시스템과 공학적 표준화의 초기 사례다."
    }
  ],
  "warnings": []
}
```
