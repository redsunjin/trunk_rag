# Vector Store 운영 정책 (Trunk RAG)

목적:
- 데이터 증가 시 속도 저하와 품질 저하를 운영 단계에서 제어한다.
- `trunk_rag`의 경량 운영 원칙(단일 노드, 단순 파이프라인)을 유지한다.

적용 범위:
- Chroma 컬렉션 단위 인덱싱/조회 운영
- 분야별 컬렉션 분할 및 라우팅 정책 연동(`docs/COLLECTION_ROUTING_POLICY.md`)

## 1) 왜 정책이 필요한가

벡터스토어 데이터가 증가하면 다음 리스크가 생긴다.

1. 속도 저하
- 검색 후보가 많아질수록 p95 응답 지연이 증가

2. 품질 저하
- 유사하지만 덜 관련된 청크가 상위에 노출(노이즈 증가)
- 중복/유사 청크가 많으면 핵심 근거 탐색이 약해짐

## 2) 운영 지표

최소 추적 지표:
- `vectors_total`: 컬렉션 총 벡터 수
- `query_latency_p95_ms`: `/query` p95 응답 지연
- `duplicate_chunk_ratio`: 중복/근접 중복 청크 비율(샘플링 기준)
- `reindex_duration_s`: `/reindex` 소요 시간

## 3) 용량 기준 (컬렉션당)

주의:
- cap은 "토큰 총합"이 아니라 "벡터(청크) 수" 기준으로 적용한다.
- 현재 가정은 벡터 1개당 약 1,000토큰(청크 기준)이다.
- 실제 하드웨어/문서 특성에 맞게 추후 조정한다.

1. Soft Cap
- `30,000` vectors/collection
- 조치:
  - 신규 적재 전 중복 제거 우선
  - 도메인/주제 단위 분리 계획 수립

2. Hard Cap
- `50,000` vectors/collection
- 조치:
  - 신규 적재 중단(차단)
  - 컬렉션 분리(예: 도메인/시기/문서군) 후 재인덱싱

참고(대략 환산):
- `30,000` vectors는 총량 기준 약 `30M tokens`
- `50,000` vectors는 총량 기준 약 `50M tokens`
- 오버랩/중복으로 인해 실제 원문량은 이보다 작다.

## 4) 인덱싱/등록 정책

1. 등록 전 검증
- `usable=true` 문서만 적재
- 검증 실패 문서는 반려하고 사유(`reasons[]`) 반환

2. 적재 기준
- projected vectors가 Hard Cap 초과 시 적재 거부
- Soft Cap 이상에서는 승인 절차(분리 계획 포함) 없이 대량 적재 금지

3. 중복 관리
- 동일 source + 유사 본문 반복 적재 금지
- 정기 점검으로 중복 청크 정리

## 5) 성능/품질 저하 대응 순서

1. 중복 청크 제거
2. 컬렉션 분리(도메인/문서군 기준)
3. 검색 파라미터 튜닝(`k`, `fetch_k`)
4. 필요 시 후순위 기능 검토
- 토큰 기준 청킹
- 하이브리드 검색(BM25 + Vector)
- rerank

## 6) 컬렉션 분할 원칙

1. 도메인(분야) 단위 분할을 우선한다.
2. 컬렉션당 cap(`30k~50k vectors`)을 넘기지 않도록 운영한다.
3. 질의는 단순 라우팅으로 해당 컬렉션만 조회한다.
4. 다중 분야 질의는 최대 2개 컬렉션 병렬 조회로 제한한다.

## 7) 현재 상태

- 현재 샘플 데이터 기준 벡터 수: `37`
- 당장 용량 한계는 아니며, 정책은 확장 대비용 기준이다.
